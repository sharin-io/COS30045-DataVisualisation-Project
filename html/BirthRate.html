<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="ASEAN Birth Rate Visualization exploring demographic trends in Southeast Asia from 1990 to 2023">
    <title>ASEAN Birth Rate Visualization</title>

    <!-- Linking CSS for consistent styling -->
    <link rel="stylesheet" href="../style/birthrate.css">

    <!-- D3.js library for interactive visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>
    <!-- Main Container -->
    <div class="container">

        <!-- Introduction Alert -->
        <div id="intro-alert" class="alert">
            <div class="alert-icon">ℹ️</div>
            <p>Explore ASEAN's birth rate trends from 1990 to 2023. Use the interactive map to understand how birth
                rates have evolved across the region.</p>
            <button class="close-btn" onclick="closeIntro()">×</button>
        </div>

        <!-- Main Visualization Card -->
        <div class="card">
            <div class="card-header">
                <h1>ASEAN Birth Rate Trends (1990-2023)</h1>
                <p class="subtitle">Interactive visualization of birth rate dynamics across Southeast Asia</p>
            </div>

            <div class="card-content">
                <!-- Year slider and play button -->
                <div class="controls">
                    <label for="yearSlider" class="year-label">Year: <span id="yearDisplay">2023</span></label>
                    <input type="range" id="yearSlider" min="1990" max="2023" value="2023" class="slider">
                    <button id="playButton" class="play-btn">Play Animation</button>
                </div>

                <!-- Map container -->
                <div class="map-container">

                    <!-- Tooltip -->
                    <div id="tooltip" class="tooltip"></div>
                    <svg id="#map" width="fit-content" height="700"></svg>


                    <!-- Insight Panel -->
                    <div id="insight-panel" class="insight-panel hidden">
                        <h3 class="insight-title">Regional Highlights</h3>
                        <p class="insight-content">Key trends and observations will display here based on user
                            interaction.
                        </p>
                    </div>

                    <!-- Observations -->
                    <div class="observations">
                        <h3>Key Observations</h3>
                        <ul>
                            <li>Higher birth rates are more prevalent in countries with younger populations</li>
                            <li>Countries like Singapore and Brunei show a steady decline in birth rates</li>
                            <li>Growth trends differ significantly between urban and rural regions</li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>

        <!-- JavaScript for Visualization and Alert Close Function -->
        <script>const width = 1200;
            const height = 900;
            const svg = d3.select("#map");
            const tooltip = d3.select("#tooltip");
            const yearSlider = document.getElementById("yearSlider");
            const yearDisplay = document.getElementById("yearDisplay");
            const playButton = document.getElementById("playButton");

            const color = d3.scaleSequential(d3.interpolateYlOrRd)
                .domain([0, 30]); // Define the color range for the birth rate

            const projection = d3.geoMercator()
                .center([115, 5])  // Centered on ASEAN region
                .scale(1000)
                .translate([width / 2, height / 2]);

            const path = d3.geoPath().projection(projection);

            // Load world map data and birth rate data
            Promise.all([
                d3.json("../data/asia.geojson"),
                d3.csv("../data/birthrate.csv")
            ]).then(([worldData, birthData]) => {
                const birthRates = {};
                birthData.forEach(d => {
                    const countryCode = d['Country Code'];
                    if (!birthRates[countryCode]) {
                        birthRates[countryCode] = {};
                    }
                    birthRates[countryCode][d.Year] = +d['Birth Rate'];
                });

                // Create zoom behavior
                const zoom = d3.zoom()
                    .scaleExtent([1, 8])  // Define zoom limits
                    .on("zoom", (event) => {
                        g.attr("transform", event.transform);  // Apply zoom and pan to the group
                    });

                // Apply zoom behavior to the SVG container
                svg.call(zoom);

                // Create the group element to hold map paths
                const g = svg.append("g");

                // Update map function
                function updateMap(year) {
                    g.selectAll(".country")
                        .data(worldData.features)
                        .join("path")
                        .attr("class", "country")
                        .attr("d", path)
                        .attr("fill", d => {
                            const rate = birthRates[d.id]?.[year];
                            return rate ? color(rate) : "#ccc";
                        })
                        .on("mouseover", (event, d) => {
                            const rate = birthRates[d.id]?.[year];
                            tooltip
                                .style("opacity", 1)
                                .html(`
                            <strong>${d.properties.name}</strong><br/>
                            Birth Rate: ${rate ? rate.toFixed(1) : "No data"} per 1,000 people<br/>
                            Year: ${year}
                        `)
                                .style("left", (event.pageX + 10) + "px")
                                .style("top", (event.pageY - 10) + "px");
                        })
                        .on("mouseout", () => {
                            tooltip.style("opacity", 0);
                        })
                        .on("click", (event, d) => {
                            const rate = birthRates[d.id]?.[year];
                            // Optionally handle click event for more detailed info
                            alert(`${d.properties.name} Birth Rate in ${year}: ${rate ? rate.toFixed(1) : "No data"} per 1,000 people`);
                        });
                }

                // Initialize map with current year
                updateMap(2023);

                // Handle year slider input
                yearSlider.addEventListener("input", (event) => {
                    const selectedYear = parseInt(event.target.value);
                    yearDisplay.textContent = selectedYear;
                    updateMap(selectedYear);
                });

                // Handle play/pause button
                let isPlaying = false;
                let animationInterval;
                playButton.addEventListener("click", () => {
                    if (isPlaying) {
                        clearInterval(animationInterval);
                        playButton.textContent = "Play Animation";
                    } else {
                        playButton.textContent = "Pause Animation";
                        let currentYear = parseInt(yearSlider.value);
                        animationInterval = setInterval(() => {
                            currentYear++;
                            if (currentYear > 2023) {
                                currentYear = 1990;
                            }
                            yearSlider.value = currentYear;
                            yearDisplay.textContent = currentYear;
                            updateMap(currentYear);
                        }, 200);
                    }
                    isPlaying = !isPlaying;
                });
                // Handle hover effect for country
                function updateMap(year) {
                    g.selectAll(".country")
                        .data(worldData.features)
                        .join("path")
                        .attr("class", "country")
                        .attr("d", path)
                        .attr("fill", d => {
                            const rate = birthRates[d.id]?.[year];
                            return rate ? color(rate) : "#ccc";
                        })
                        .on("mouseover", (event, d) => {
                            const rate = birthRates[d.id]?.[year];
                            const countryName = d.properties.name;
                            const birthRate = rate ? rate.toFixed(1) : "No data";

                            // Position the tooltip near the country
                            const [x, y] = path.centroid(d); // Get the center coordinates of the country

                            tooltip
                                .style("opacity", 1)
                                .html(`
                            <strong>${countryName}</strong><br/>
                            Birth Rate: ${birthRate} per 1,000 people<br/>
                            Year: ${year}
                        `)
                                .style("left", `${x + 10}px`) // Position the tooltip slightly to the right
                                .style("top", `${y - 20}px`); // Position the tooltip above the country
                        })
                        .on("mouseout", () => {
                            tooltip.style("opacity", 0); // Hide the tooltip when mouse leaves
                        })
                        .on("click", (event, d) => {
                            const rate = birthRates[d.id]?.[year];
                            alert(`${d.properties.name} Birth Rate in ${year}: ${rate ? rate.toFixed(1) : "No data"} per 1,000 people`);
                        });
                }
            }).catch(error => {
                document.getElementById('error-container').innerText = 'Failed to load data. Please try again later.';
                console.error('Error loading data:', error);
            });

            function closeIntro() {
                document.getElementById("intro-alert").style.display = "none";
            }
        </script>
</body>

</html>
